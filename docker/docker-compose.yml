# Mimir Lite - Full Stack for Ubuntu Server
# Neo4j + mimir-lite in Docker
# Usage: cd docker && docker compose up -d

services:
  neo4j:
    image: neo4j:5.15
    container_name: mimir-neo4j
    restart: unless-stopped
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - ./data/neo4j:/data
    ports:
      - "7474:7474"
      - "7687:7687"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  mimir:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: mimir-lite:local
    container_name: mimir-server
    restart: unless-stopped
    environment:
      # Database
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password

      # Server
      - NODE_ENV=production
      - PORT=3000

      # Embeddings (Ollama - adjust URL for your setup)
      # For Ollama on same host: http://host.docker.internal:11434 (Mac/Win) or http://172.17.0.1:11434 (Linux)
      - MIMIR_EMBEDDINGS_PROVIDER=ollama
      - MIMIR_EMBEDDINGS_API=http://172.17.0.1:11434
      - MIMIR_EMBEDDINGS_ENABLED=true
      - MIMIR_EMBEDDINGS_MODEL=mxbai-embed-large
      - MIMIR_EMBEDDINGS_DIMENSIONS=1024

      # Search
      - MIMIR_MIN_SIMILARITY=0.5

      # Features
      - MIMIR_AUTO_INDEX_DOCS=false
      - MIMIR_VERBOSE=false

      # Performance
      - MIMIR_INDEXING_THREADS=3

      # File Exclusion
      - MIMIR_SENSITIVE_FILES=*.po,*.pot,*.lock,*.log,package-lock.json,yarn.lock

    volumes:
      # Mount your project folders here
      # Example:
      # - /home/user/projects:/workspace/projects:ro
      # - /home/user/docs:/workspace/docs:ro

      # Data persistence
      - ./data/mimir:/app/data

    ports:
      - "3000:3000"
    depends_on:
      neo4j:
        condition: service_healthy

networks:
  default:
    name: mimir-network
